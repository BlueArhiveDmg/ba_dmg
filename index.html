<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//zh-Hant">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<title>碧藍檔案傷害計算機</title>
</head>
	<body>
	<div class="CharStatDiv">
		<div>
			<div>
				<input type="range" id="charLevel" value="83" min="1" max="100" 
				oninput="updateCharLevel(this.value);">
				<input style="width:2em" type="text" id="charLevelText" value="83" 
				oninput="updateCharLevel(this.value);">
				<output style="width:2em" type="text">Level</output>
			</div>
			<div>
				<input type="range" id="starGrade" value="8" min="1" max="8" 
				oninput="updateStarGrade(this.value);">
				<input style="width:2em" type="text" id="charStarGradeText" value="8"
				oninput="updateStarGrade(this.value);">
				<output style="width:8em" type="text" id="StarGradeString">Weapon 3</output>
			</div>
			<div>
				<input type="range" id="bond0" value="20" min="1" max="100" 
				oninput="updatebond(this.value, 0);">
				<input style="width:3em" type="text" id="bond0text" value="20"
				oninput="updatebond(this.value, 0);">
				<output style="width:10em" type="text" id="bond0String">bond0</output>
			</div>
			<div>
				<input type="range" id="bond1" value="20" min="1" max="100" 
				oninput="updatebond(this.value, 1);">
				<input style="width:3em" type="text" id="bond1text" value="20"
				oninput="updatebond(this.value, 1);">
				<output style="width:10em" type="text" id="bond1String">bond1</output>
			</div>
			<div>
				<input type="range" id="bond2" value="20" min="1" max="100" 
				oninput="updatebond(this.value, 2);">
				<input style="width:3em" type="text" id="bond2text" value="20"
				oninput="updatebond(this.value, 2);">
				<output style="width:10em" type="text" id="bond2String">bond2</output>
			</div>
			<div>
				<input type="range" id="ExLv" value="5" min="1" max="10" 
				oninput="updateExLv(this.value);">
				<input style="width:3em" type="text" id="ExLvtext" value="5"
				oninput="updateExLv(this.value);">
				<output style="width:10em" type="text" id="ExLvString">Ex Level</output>
			</div>
		</div>
		<div>
			<!-- <button onclick="getJson()">Get list</button> -->
			<select name="character" id="character"> 
			<option value="-1" selected="" disabled="">character</option> 
			</select> 
		</div>	
		<textarea id="characterStat" name="characterStat" rows="10" cols="30"></textarea>	
	</div>
	<div class="Data-Content">
			<div class="Data-Title">
				<label for="Atk">面板攻擊力</label><br>
				<label for="EquAtk">裝備攻擊%</label><br>
				<label for="SPAtk">支援攻擊力</label><br>
				<!--<label for="Star2Atk">專2攻擊力</label><br />-->
				<label for="AtkBuff">攻擊力Buff%</label><br>
				<label for="SkillDmg">技能倍率%</label><br>
				<label for="LevelCorrection">等級補正</label><br>
				<label for="CrtDmgEqu">會心傷害裝備</label><br>
				<label for="CrtDmgBuff">會心傷害buff%</label><br>
				<label for="CrtDmgRes">會心傷害抵抗%</label><br>
				<label for="Stable">安定值</label><br>
				<label for="BossDef">BOSS防禦</label><br>
				<label for="DefReduce">防禦Debuff%</label><br>
			</div>
			<div class="Data-Items">
				<input type="text" id="Atk" value="6538" onchange="CalculatorDmg()"><br>
				<input type="text" id="EquAtk" value="40" onchange="CalculatorDmg()"><br>
				<input type="text" id="SPAtk" value="670" onchange="CalculatorDmg()"><br>
				<!--<input type="text" id="Star2Atk" value=0 /><br />-->
				<input type="text" id="AtkBuff" value="0" onchange="CalculatorDmg()"><br>		
				<input type="text" id="SkillDmg" value="666" onchange="CalculatorDmg()"><br>
				<input type="text" id="LevelCorrection" value="1" onchange="CalculatorDmg()"><br>
				<input type="text" id="CrtDmgEqu" value="3900" onchange="CalculatorDmg()"><br>
				<input type="text" id="CrtDmgBuff" value="0" onchange="CalculatorDmg()"><br>
				<input type="text" id="CrtDmgRes" value="50" onchange="CalculatorDmg()"><br>
				<input type="text" id="Stable" value="2056" onchange="CalculatorDmg()"><br>
				<input type="text" id="BossDef" value="120" onchange="CalculatorDmg()"><br>
				<input type="text" id="DefReduce" value="0" onchange="CalculatorDmg()"><br>
			</div>
	</div>
	<div class="Data-buff">
		<div>
		  <input type="checkbox" id="Ehnatk" name="2技攻擊強化" value="26.6" onchange="CalculatorDmg()">
		  <label for="2技攻擊強化">2技攻擊強化 26.6%</label>
		</div>
		<div>
		  <input type="checkbox" id="atkAura" name="攻擊光環" value="17.3" onchange="CalculatorDmg()">
		  <label for="攻擊光環">攻擊光環 17.3%</label>
		</div>
		<div>
		  <input type="checkbox" id="kotamaAtkBuff" name="小玉攻擊BUFF" value="47.4" onchange="CalculatorDmg()">
		  <label for="小玉攻擊BUFF">小玉攻擊BUFF 47.4%</label>
		</div>
		<div>
		  <input type="checkbox" id="akoCrtDmgBuff" name="亞子爆傷BUFF" value="73.3" onchange="CalculatorDmg()">
		  <label for="亞子爆傷BUFF">亞子爆傷BUFF 73.3%</label>
		</div>
		<div>
		  <input type="checkbox" id="newAtkBuff" name="天才美少女攻擊BUFF" value="105" onchange="CalculatorDmg()">
		  <label for="天才美少女攻擊BUFF">天才美少女攻擊BUFF 105%</label>
		</div>
		<div>
		  <input type="checkbox" id="EhnCrtDmg" name="2技爆傷強化" value="26.6" onchange="CalculatorDmg()">
		  <label for="2技爆傷強化">2技爆傷強化 26.6%</label>
		</div>
		<div>
		  <input type="checkbox" id="CrtDmgAura" name="爆傷光環" value="17.3" onchange="CalculatorDmg()">
		  <label for="爆傷光環">爆傷光環 17.3%</label>
		</div>
		<div>
		<select id="weak"  onchange="CalculatorDmg()">
			<option selected="" disabled="">屬性補正</option>
			<option value="0.5">抵抗 0.5</option>
			<option value="1">普通 1</option>
			<option value="2" selected="">弱點 2</option>
		</select><br>
		</div>
		<div>
		<select id="terrain" onchange="CalculatorDmg()">
			<option selected="" disabled="">地形補正</option>
			<option value="0.8">大紅臉 0.8</option>
			<option value="0.9">紅臉 0.9</option>
			<option value="1.0">黃臉 1.0</option>
			<option value="1.1">綠臉 1.1</option>
			<option value="1.2">大綠臉 1.2</option>
			<option value="1.3" selected="">墨鏡 1.3</option>
		</select><br>
		</div>
	</div>
	<div class="dmg-table">
		<table id="dmgTableId">
			<tr>
				<th bgcolor="gray">普通傷害</th>
				<th bgcolor="gray">最低普通傷害</th>
				<th bgcolor="#FF2D2D">爆擊傷害</th>
				<th bgcolor="#FF2D2D">最低爆擊傷害</th>
				<th>character</th>
			</tr>
			<tr>
				<td bgcolor="#00FF00">0</td>
				<td bgcolor="#00FF00">0</td>
				<td bgcolor="orange">0</td>
				<td bgcolor="orange">0</td>
				<td>伊織</td>
			</tr>
		</table>
	</div>
<style type="text/css">
<!-- 	.Data-Content {        
		width: auto;        
		margin-left: 28%;
	}
   
	@media screen and (max-width: 720px) and (orientation: portrait) {
		.Data-Content {        
			width: auto;        
			margin-left: 2%;			
		}
    } -->

	.Data-Content {        
		line-height: 21px;
	}
	
	.CharStatDiv {	
		float: left;
		width: auto;
		margin-right: 20px;
	}

	.Data-Title {	
		float: left;
		width: auto;
		margin-right: 20px;
	}

	.Data-Items {
		float: left;
		margin-right: 20px;
	}
	
	.Data-buff {
		white-space:nowrap;		
	}
	
    .dmg-table {
		clear:both;		
    }
	
	td, th {
	  border: 1px solid #dddddd;
	  text-align: left;
	  padding: 8px;
	}
</style>
<script>
class studentStat {
  name = "伊織"
  weaponGrade = 8;
  attack = 4144.41;
  WeaponAttack = 422;
  Weapon2Attack = 0;
  Weapon2CrtDmg = 0;
  TsAtk = 0;
  TsInheritAtk = 0;
  bondAtk = [];
  EquHead = "Hat";
  EquAcc = "Watch";
  ExSkill = 666;
  CriticalDamage = 200;
  Stability = 2056
  constructor() {
  }
};
var student = new studentStat();
var CharLevel = 83;
var CharacterList;
var SummonsList;
var star = 4;
var EquAtkKey = { "Hat": 40, "Gloves" : 35, "Shoes": 30};
var EquCrtDmgKey = { "Hat": 1800, "Gloves": 0, "Shoes": 0, "Watch":2100, "Charm":0, "Necklace":0};
transcendence = [[0, 1000, 2200, 3600, 5300], [0, 750, 1750, 2950, 4450], [0, 500, 1200, 2100, 3500]]
starGradeStr = ["1 star", "2 star", "3 star", "4 star", "5 star", "Weapon 1", "Weapon 2", "Weapon 3"]
function updateExLv(val)
{
	$('#ExLv').val(val);
	$('#ExLvtext').val(val);
	var idx = document.getElementById('character').value;
	CharacterStatUpdate(idx);
}
function updatebond(val, updatebondIndex)
{
	$('#' + 'bond' + updatebondIndex).val(val);
	$('#' + 'bond' + updatebondIndex + "text").val(val);
	var idx = document.getElementById('character').value;
	CharacterStatUpdate(idx);
}
function updateStarGrade(val)
{
	document.getElementById('charStarGradeText').value = val; 
	document.getElementById('starGrade').value = val; 
	document.getElementById('StarGradeString').value = starGradeStr[val - 1]; 
	star = Math.min(5, val) - 1;
	student.weaponGrade = $('#starGrade').val()
	var idx = document.getElementById('character').value;
	CharacterStatUpdate(idx);
}
function updateCharLevel(val)
{
	document.getElementById('charLevelText').value = val; 
	document.getElementById('charLevel').value = val; 
	CharLevel = val;
	var idx = document.getElementById('character').value;
	CharacterStatUpdate(idx);
}

function getWeapon2Skill(idx) 
{
	var text = CharacterList[idx].Skills[4].Desc
	let result = '';
	let regex = /\<b:(.+?)\>/g;
	
	result = text.match(regex)
	
	text = result[0].match('CriticalDamage')
	if (text) {
		student.Weapon2CrtDmg = parseFloat(CharacterList[idx].Skills[4].Parameters[0][9]);
		result = "Weapon2 CriticalDamage: " + CharacterList[idx].Skills[4].Parameters[0][9]
		return result
	} else {
		student.Weapon2CrtDmg = 0;
	}
	text = result[0].match('ATK')
	if (text) {
		student.Weapon2Attack = parseFloat(CharacterList[idx].Skills[4].Parameters[0][9]);
		result = "Weapon2 ATK: " + CharacterList[idx].Skills[4].Parameters[0][9]
		return result
	} else {
		student.Weapon2Attack = 0;
	}
	result = ''
	return result
}

function getSkillText(text, params, level) 
{
    let result = text
    let regex

    regex = /[0-9.]+(?:%|s|秒|초| วินาที)/g
    //result = result.replace(regex, function(match) {return `<strong>${match}</strong>`})

    for (let i = 1; i <= params.length; i++) {
        while (result.includes(`<?${i}>`)) {
            result = result.replace(`<?${i}>`, `${params[i-1][level]}`)
        }
    }

	return result
}
function getStudentbondAtk(idx, bondIdx)
{
	var attack = 0;

	for (let i = 1; i < Math.min($('#' + 'bond' + bondIdx).val(), 50); i++) {
        if (i < 20) {
            attack += CharacterList[idx].FavorStatValue[Math.floor(i / 5)][0]
        } else if (i < 50) {
            attack += CharacterList[idx].FavorStatValue[2 + Math.floor(i / 10)][0]
        }
    }
	
	return attack
}

function getStudentIdx(id) 
{
	var idx = 9999999;
	for(var x = 0; x < CharacterList.length; x++){ 
		if (CharacterList[x].Id == id) {
			idx = x
			break
		}
	}
	
	return idx
}

function getTotalBondAtk() 
{
	var attack = 0;
	for(var x = 0; x < student.bondAtk.length; x++){ 
		attack += student.bondAtk[x];
	}
	
	return attack
}

function CharacterStatUpdate(idx)
{
	var exLevel = 5 - 1;
	var typeTS = 0;
	var summonIdx = 0;
	var attack = 0;
	var level = CharLevel;
	var weaponLevel = (student.weaponGrade >= 6) ? 30 + (student.weaponGrade - 6) * 10 : 0;
	if (idx < 0) {
		return 0;
	}
	
	if (CharacterList[idx].TacticRole == "Vehicle") {
		for(var x = 0; x < SummonsList.length; x++){ 
			if (SummonsList[x].Id == CharacterList[idx].Summons[0].Id) {
				typeTS = 1
				summonIdx = x
				break
			}
		}		
	}

	textarea = document.getElementById('characterStat');
	textarea.value = '';
	textarea.value += "Name:" + CharacterList[idx].Name + '\n';
	student.name = CharacterList[idx].Name
	attack = (CharacterList[idx].AttackPower100 - CharacterList[idx].AttackPower1) / 99;
	attack = CharacterList[idx].AttackPower1 + attack * (level - 1);
	attack = attack * (1 + transcendence[0][star] / 10000);  
	textarea.value += "Attack:" + (attack).toFixed(2) + '\n';
	if (typeTS) {
		student.attack = parseFloat((attack).toFixed(2));
		student.TsInheritAtk = parseFloat((CharacterList[idx].Summons[0].InheritCasterAmount[0][exLevel] / 10000)).toFixed(2) * student.attack;
		attack = (SummonsList[summonIdx].AttackPower100 - SummonsList[summonIdx].AttackPower1) / 99;
		attack = SummonsList[summonIdx].AttackPower1 + attack * (level - 1);
		student.TsAtk = parseFloat((attack).toFixed(2));
		textarea.value += "TS Attack:" + (attack).toFixed(2) + '\n';
	} else {
		student.TsAtk = 0;
		student.attack = parseFloat((attack).toFixed(2));
	}
	attack = 0;
	if (weaponLevel > 0) {
		attack = (CharacterList[idx].Weapon.AttackPower100 - CharacterList[idx].Weapon.AttackPower1) / 99;
		attack = CharacterList[idx].Weapon.AttackPower1 + (attack).toFixed(2) * (weaponLevel - 1);		
	}
	student.WeaponAttack = parseFloat((attack).toFixed(2));
	textarea.value += "WeaponAttack:" + (attack).toFixed(2) + '\n';
	
	student.bondAtk = []
	$('#' + 'bond' + '0' + "String").val(CharacterList[idx].Name);
	attack = getStudentbondAtk(idx, 0);
	textarea.value += "BondAttack: " + attack + '\n'
	student.bondAtk.push(attack);
	for(var x = 1; x < 3; x++){
		if (CharacterList[idx].FavorAlts.length < (x)) {
			$('#' + 'bond' + x).prop("disabled", true );
			$('#' + 'bond' + x + "text").prop("disabled", true );
			$('#' + 'bond' + x + "String").val("None");
		} else {
			favorAltIdx = getStudentIdx(CharacterList[idx].FavorAlts[x-1])
			attack = getStudentbondAtk(favorAltIdx, x)
			student.bondAtk.push(attack);
			textarea.value += CharacterList[favorAltIdx].Name + "BondAttack: " + attack + '\n'
			$('#' + 'bond' + x).prop("disabled", false );
			$('#' + 'bond' + x + "text").prop("disabled", false );
			$('#' + 'bond' + x + "String").val(CharacterList[favorAltIdx].Name);
		}		
	}
	
	textarea.value += "CriticalDamage:" + CharacterList[idx].CriticalDamageRate / 100 + '%\n';
	if (typeTS) {
		student.CriticalDamage = SummonsList[summonIdx].CriticalDamageRate / 100;
	} else {
		student.CriticalDamage = CharacterList[idx].CriticalDamageRate / 100;
	}
	textarea.value += getWeapon2Skill(idx) + '\n';
	textarea.value += "StabilityPoint:" + CharacterList[idx].StabilityPoint + '\n';
	if (typeTS) {
		student.Stability = SummonsList[summonIdx].StabilityPoint;
	} else {
		student.Stability = CharacterList[idx].StabilityPoint;
	}
	textarea.value += "Equipment: ";

	for(var x = 0; x < CharacterList[idx].Equipment.length; x++){ 
		textarea.value += CharacterList[idx].Equipment[x] + " "
	}
	textarea.value += '\n';
	student.EquHead = CharacterList[idx].Equipment[0];
	student.EquAcc = CharacterList[idx].Equipment[2];
	textarea.value += "EX skill:" + "\n";
	textarea.value += getSkillText(CharacterList[idx].Skills[0].Desc, CharacterList[idx].Skills[0].Parameters, $('#ExLv').val() - 1);
	if (typeTS) {
		student.ExSkill = parseFloat(CharacterList[idx].Skills[0].Parameters[1][$('#ExLv').val() - 1].replace("%",""));
	} else {
		student.ExSkill = parseFloat(CharacterList[idx].Skills[0].Parameters[0][$('#ExLv').val() - 1].replace("%",""));
	}
	
	$('#EquAtk').val(EquAtkKey[student.EquHead])
	$('#CrtDmgEqu').val(EquCrtDmgKey[student.EquHead] + EquCrtDmgKey[student.EquAcc] + student.Weapon2CrtDmg)
	if (typeTS) {
		$('#Atk').val((student.TsAtk + student.TsInheritAtk) * (1 + ($('#EquAtk').val() / 100)))
	} else {
		attack = student.attack + student.WeaponAttack + student.Weapon2Attack
		attack += getTotalBondAtk()
		$('#Atk').val(((attack) * (1 + ($('#EquAtk').val() / 100))).toFixed(2))
	}
	$('#SkillDmg').val(student.ExSkill)
	$('#Stable').val(student.Stability)
	CalculatorDmg();
}

function CharacterSelect(e)
{
	var idx = e.target.value;
	CharacterStatUpdate(idx);
}
function createCharacterList(CharacterList){ 
	var select = document.getElementById("character"); 
	select.addEventListener("change", CharacterSelect);
	for (var key in CharacterList) {
		var option = document.createElement("option"); 
		option.setAttribute("value", CharacterList[key].Id);
		option.appendChild(document.createTextNode(CharacterList[key].Name)); 
		select.appendChild(option);
	} 
} 
function getJson() {
	fetch('https://schaledb.com/data/tw/summons.json')
		.then(result => result.json())
		.then((output) => {
			SummonsList = output;
	}).catch(err => console.error(err));
	fetch('https://schaledb.com/data/tw/students.min.json')
		.then(result => result.json())
		.then((output) => {
			CharacterList = output;
			createCharacterList(CharacterList);
			
	}).catch(err => console.error(err));
}
function CalculatorDmg() {
	var myselect=document.getElementById("weak");
	var index=myselect.selectedIndex;
	var weak = parseFloat(myselect.options[index].value);
	myselect=document.getElementById("terrain");
	index=myselect.selectedIndex;
	var terrain = parseFloat(myselect.options[index].value);
	var Atk = parseFloat(document.getElementById("Atk").value);
	var EquAtk = parseFloat(document.getElementById("EquAtk").value / 100);
	var SPAtk = parseFloat(document.getElementById("SPAtk").value);
	var AtkBuff = parseFloat(document.getElementById("AtkBuff").value / 100);
	//var Star2Atk = parseFloat(document.getElementById("Star2Atk").value);
	var SkillDmg = parseFloat(document.getElementById("SkillDmg").value / 100) ;	
	var LevelCorrection = document.getElementById("LevelCorrection").value;
	var CrtDmgEqu = parseFloat(document.getElementById("CrtDmgEqu").value / 100);
	var CrtDmgBuff = parseFloat(document.getElementById("CrtDmgBuff").value / 100);
	var CrtDmgRes = parseFloat(document.getElementById("CrtDmgRes").value / 100);
	var Stable = parseFloat(document.getElementById("Stable").value);
	Stable = Stable / (1000 + Stable) + 0.2;
	var DefReduce = parseFloat(document.getElementById("DefReduce").value / 100);
	var BossDef = parseFloat(document.getElementById("BossDef").value);
	BossDef = BossDef * (1 - DefReduce);
	var atkAura = 0;
	var Ehnatk = 0;
	var kotamaAtkBuff = 0;
	var akoCrtDmgBuff = 0;
	var newAtkBuff = 0;
	var EhnCrtDmg = 0;
	var CrtDmgAura = 0;
	if (document.getElementById("atkAura").checked) {
		atkAura = parseFloat(document.getElementById("atkAura").value / 100);
	}
	if (document.getElementById("Ehnatk").checked) {
		Ehnatk = parseFloat(document.getElementById("Ehnatk").value / 100);
	}
	if (document.getElementById("kotamaAtkBuff").checked) {
		kotamaAtkBuff = parseFloat(document.getElementById("kotamaAtkBuff").value / 100);
	} 
	if (document.getElementById("akoCrtDmgBuff").checked) {
		akoCrtDmgBuff = parseFloat(document.getElementById("akoCrtDmgBuff").value / 100);
	}
	if (document.getElementById("newAtkBuff").checked) {
		newAtkBuff = parseFloat(document.getElementById("newAtkBuff").value / 100);
	}
	if (document.getElementById("EhnCrtDmg").checked) {
		EhnCrtDmg = parseFloat(document.getElementById("EhnCrtDmg").value / 100);
	}  
	if (document.getElementById("CrtDmgAura").checked) {
		CrtDmgAura = parseFloat(document.getElementById("CrtDmgAura").value / 100);
	}	
		
	var totalAtk = (Atk / (1 + EquAtk) + SPAtk) *  (1 + (AtkBuff + EquAtk + atkAura + Ehnatk + kotamaAtkBuff + newAtkBuff));
	var totalDmg = totalAtk * SkillDmg * LevelCorrection * weak * terrain;
	var dmgReduce = (BossDef + 1666.66) / 1666.66;
	var actualDmg = parseInt(totalDmg / dmgReduce);
	var actualDmgMin = parseInt(totalDmg * Stable / dmgReduce);
	var crtDmgRate = ((student.CriticalDamage + CrtDmgEqu) / 100) * (1 + CrtDmgBuff + akoCrtDmgBuff + EhnCrtDmg + CrtDmgAura) - CrtDmgRes;
	var crtDmg = parseInt(crtDmgRate * actualDmg);
	var crtDmgMin = parseInt(actualDmgMin * crtDmgRate);
	
	document.getElementById("dmgTableId").rows[1].cells[0].innerHTML = actualDmg;
	document.getElementById("dmgTableId").rows[1].cells[1].innerHTML = actualDmgMin;
	document.getElementById("dmgTableId").rows[1].cells[2].innerHTML = crtDmg;
	document.getElementById("dmgTableId").rows[1].cells[3].innerHTML = crtDmgMin;
	document.getElementById("dmgTableId").rows[1].cells[4].innerHTML = student.name;
}
window.onload = function() {
	getJson();
	document.getElementById("EquAtk").value = EquAtkKey[student.EquHead];
	document.getElementById("CrtDmgEqu").value = EquCrtDmgKey[student.EquHead] + EquCrtDmgKey[student.EquAcc];
	document.getElementById("Atk").value = ((student.attack + student.WeaponAttack) * (1 + document.getElementById("EquAtk").value / 100)).toFixed(2);
	CalculatorDmg();
}
</script>
</body></html>
