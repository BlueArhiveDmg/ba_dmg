<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//zh-Hant">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<title>碧藍檔案傷害計算機</title>
</head>
	<body>
	<div class="CharStatDiv">
		<div>
			<div>
				<input type="range" id="charLevel" value="83" min="1" max="100" 
				oninput="updateCharLevel(this.value);">
				<input style="width:2em" type="text" id="charLevelText" value="83" 
				oninput="updateCharLevel(this.value);">
				<output style="width:2em" type="text">Level</output>
			</div>
			<div>
				<input type="range" id="starGrade" value="5" min="1" max="8" 
				oninput="updateStarGrade(this.value);">
				<input style="width:2em" type="text" id="charStarGradeText" value="5"
				oninput="updateStarGrade(this.value);">
				<output style="width:2em" type="text" id="StarGradeString">5 star</output>
			</div>
		</div>
		<div>
			<!-- <button onclick="getJson()">Get list</button> -->
			<select name="character" id="character"> 
			<option value="-1" selected="" disabled="">character</option> 
			</select> 
		</div>	
		<textarea id="characterStat" name="characterStat" rows="10" cols="30"></textarea>	
	</div>
	<div class="Data-Content">
			<div class="Data-Title">
				<label for="Atk">面板攻擊力</label><br>
				<label for="EquAtk">裝備攻擊%</label><br>
				<label for="SPAtk">支援攻擊力</label><br>
				<!--<label for="Star2Atk">專2攻擊力</label><br />-->
				<label for="AtkBuff">攻擊力Buff%</label><br>
				<label for="SkillDmg">技能倍率%</label><br>
				<label for="LevelCorrection">等級補正</label><br>
				<label for="CrtDmgEqu">會心傷害裝備</label><br>
				<label for="CrtDmgBuff">會心傷害buff%</label><br>
				<label for="CrtDmgRes">會心傷害抵抗%</label><br>
				<label for="Stable">安定值</label><br>
				<label for="BossDef">BOSS防禦</label><br>
				<label for="DefReduce">防禦Debuff%</label><br>
			</div>
			<div class="Data-Items">
				<input type="text" id="Atk" value="6538" onchange="CalculatorDmg()"><br>
				<input type="text" id="EquAtk" value="40" onchange="CalculatorDmg()"><br>
				<input type="text" id="SPAtk" value="670" onchange="CalculatorDmg()"><br>
				<!--<input type="text" id="Star2Atk" value=0 /><br />-->
				<input type="text" id="AtkBuff" value="0" onchange="CalculatorDmg()"><br>		
				<input type="text" id="SkillDmg" value="666" onchange="CalculatorDmg()"><br>
				<input type="text" id="LevelCorrection" value="1" onchange="CalculatorDmg()"><br>
				<input type="text" id="CrtDmgEqu" value="3900" onchange="CalculatorDmg()"><br>
				<input type="text" id="CrtDmgBuff" value="0" onchange="CalculatorDmg()"><br>
				<input type="text" id="CrtDmgRes" value="50" onchange="CalculatorDmg()"><br>
				<input type="text" id="Stable" value="2056" onchange="CalculatorDmg()"><br>
				<input type="text" id="BossDef" value="120" onchange="CalculatorDmg()"><br>
				<input type="text" id="DefReduce" value="0" onchange="CalculatorDmg()"><br>
			</div>
	</div>
	<div class="Data-buff">
		<div>
		  <input type="checkbox" id="Ehnatk" name="2技攻擊強化" value="26.6" onchange="CalculatorDmg()">
		  <label for="2技攻擊強化">2技攻擊強化 26.6%</label>
		</div>
		<div>
		  <input type="checkbox" id="atkAura" name="攻擊光環" value="17.3" onchange="CalculatorDmg()">
		  <label for="攻擊光環">攻擊光環 17.3%</label>
		</div>
		<div>
		  <input type="checkbox" id="kotamaAtkBuff" name="小玉攻擊BUFF" value="47.4" onchange="CalculatorDmg()">
		  <label for="小玉攻擊BUFF">小玉攻擊BUFF 47.4%</label>
		</div>
		<div>
		  <input type="checkbox" id="akoCrtDmgBuff" name="亞子爆傷BUFF" value="73.3" onchange="CalculatorDmg()">
		  <label for="亞子爆傷BUFF">亞子爆傷BUFF 73.3%</label>
		</div>
		<div>
		  <input type="checkbox" id="newAtkBuff" name="天才美少女攻擊BUFF" value="105" onchange="CalculatorDmg()">
		  <label for="天才美少女攻擊BUFF">天才美少女攻擊BUFF 105%</label>
		</div>
		<div>
		  <input type="checkbox" id="EhnCrtDmg" name="2技爆傷強化" value="26.6" onchange="CalculatorDmg()">
		  <label for="2技爆傷強化">2技爆傷強化 26.6%</label>
		</div>
		<div>
		  <input type="checkbox" id="CrtDmgAura" name="爆傷光環" value="17.3" onchange="CalculatorDmg()">
		  <label for="爆傷光環">爆傷光環 17.3%</label>
		</div>
		<div>
		<select id="weak"  onchange="CalculatorDmg()">
			<option selected="" disabled="">屬性補正</option>
			<option value="0.5">抵抗 0.5</option>
			<option value="1">普通 1</option>
			<option value="2" selected="">弱點 2</option>
		</select><br>
		</div>
		<div>
		<select id="terrain" onchange="CalculatorDmg()">
			<option selected="" disabled="">地形補正</option>
			<option value="0.8">大紅臉 0.8</option>
			<option value="0.9">紅臉 0.9</option>
			<option value="1.0">黃臉 1.0</option>
			<option value="1.1">綠臉 1.1</option>
			<option value="1.2">大綠臉 1.2</option>
			<option value="1.3" selected="">墨鏡 1.3</option>
		</select><br>
		</div>
	</div>
	<div class="dmg-table">
		<table id="dmgTableId">
			<tr>
				<th bgcolor="gray">普通傷害</th>
				<th bgcolor="gray">最低普通傷害</th>
				<th bgcolor="#FF2D2D">爆擊傷害</th>
				<th bgcolor="#FF2D2D">最低爆擊傷害</th>
			</tr>
			<tr>
				<td bgcolor="#00FF00">0</td>
				<td bgcolor="#00FF00">0</td>
				<td bgcolor="orange">0</td>
				<td bgcolor="orange">0</td>
			</tr>
		</table>
	</div>
<style type="text/css">
<!-- 	.Data-Content {        
		width: auto;        
		margin-left: 28%;
	}
   
	@media screen and (max-width: 720px) and (orientation: portrait) {
		.Data-Content {        
			width: auto;        
			margin-left: 2%;			
		}
    } -->
	.Data-Content {        
		line-height: 21px;
	}
	
	.CharStatDiv {	
		float: left;
		width: auto;
		margin-right: 20px;
	}

	.Data-Title {	
		float: left;
		width: auto;
		margin-right: 20px;
	}

	.Data-Items {
		float: left;
		margin-right: 20px;
	}
	
	.Data-buff {
		white-space:nowrap;		
	}
	
    .dmg-table {
		clear:both;		
    }
	
	td, th {
	  border: 1px solid #dddddd;
	  text-align: left;
	  padding: 8px;
	}
</style>
<script>
class studentStat {
  attack = 4144.41;
  WeaponAttack = 422;
  EquHead = "Hat";
  EquAcc = "Watch";
  ExSkill = 666;
  CriticalDamage = 200;
  Stability = 2056
  constructor() {
  }
};
var student = new studentStat();
var CharLevel = 83;
var CharacterList;
var star = 4;
var EquAtkKey = { "Hat": 40, "Gloves" : 35, "Shoes": 30};
var EquCrtDmgKey = { "Hat": 1800, "Gloves": 0, "Shoes": 0, "Watch":2100, "Charm":0, "Necklace":0};
transcendence = [[0, 1000, 2200, 3600, 5300], [0, 750, 1750, 2950, 4450], [0, 500, 1200, 2100, 3500]]
starGradeStr = ["1 star", "2 star", "3 star", "4 star", "5 star", "Weapon 1", "Weapon 2", "Weapon 3"]
function updateStarGrade(val)
{
	document.getElementById('charStarGradeText').value = val; 
	document.getElementById('starGrade').value = val; 
	document.getElementById('StarGradeString').value = starGradeStr[val - 1]; 
	star = Math.min(5, val) - 1;
	var idx = document.getElementById('character').value;
	CharacterStatUpdate(idx);
}
function updateCharLevel(val)
{
	document.getElementById('charLevelText').value = val; 
	document.getElementById('charLevel').value = val; 
	CharLevel = val;
	var idx = document.getElementById('character').value;
	CharacterStatUpdate(idx);
}

function getSkillText(text, params, level) {
    
    let result = text
    let regex

    regex = /[0-9.]+(?:%|s|秒|초| วินาที)/g
    result = result.replace(regex, function(match) {return `<strong>${match}</strong>`})

    for (let i = 1; i <= params.length; i++) {
        while (result.includes(`<?${i}>`)) {
            result = result.replace(`<?${i}>`, `${params[i-1][level]}`)
        }
    }

	return result
}
function CharacterStatUpdate(idx)
{
	var attack = 0;
	var level = CharLevel;
	var weaponLevel = 50;
	if (idx < 0) {
		return 0;
	}

	textarea = document.getElementById('characterStat');
	textarea.value = '';
	textarea.value += "Name:" + CharacterList[idx].Name + '\n';
	attack = (CharacterList[idx].AttackPower100 - CharacterList[idx].AttackPower1) / 99;
	attack = CharacterList[idx].AttackPower1 + attack * (level - 1);
	attack = attack * (1 + transcendence[0][star] / 10000);  
	textarea.value += "Attack:" + (attack).toFixed(2) + '\n';
	student.attack = parseFloat((attack).toFixed(2));
	attack = (CharacterList[idx].Weapon.AttackPower100 - CharacterList[idx].Weapon.AttackPower1) / 99;
	attack = CharacterList[idx].Weapon.AttackPower1 + (attack).toFixed(2) * (weaponLevel - 1);
	student.WeaponAttack = parseFloat((attack).toFixed(2));
	textarea.value += "WeaponAttack:" + (attack).toFixed(2) + '\n';
	textarea.value += "CriticalDamage:" + CharacterList[idx].CriticalDamageRate / 100 + '%\n';
	student.CriticalDamage = CharacterList[idx].CriticalDamageRate / 100;
	textarea.value += "StabilityPoint:" + CharacterList[idx].StabilityPoint + '\n';
	student.Stability = CharacterList[idx].StabilityPoint;
	textarea.value += "Equipment Head:" + CharacterList[idx].Equipment[0] + '\n';
	student.EquHead = CharacterList[idx].Equipment[0];
	textarea.value += "Equipment Accessory:" + CharacterList[idx].Equipment[2] + '\n';
	student.EquAcc = CharacterList[idx].Equipment[2];
	textarea.value += "EX skill:" + "\n" ;
	textarea.value += getSkillText(CharacterList[idx].Skills[0].Desc, CharacterList[idx].Skills[0].Parameters, 4);
	student.ExSkill = parseFloat(CharacterList[idx].Skills[0].Parameters[0][4].replace("%",""));
	
	document.getElementById("EquAtk").value = EquAtkKey[student.EquHead];
	document.getElementById("CrtDmgEqu").value = EquCrtDmgKey[student.EquHead] + EquCrtDmgKey[student.EquAcc];
	document.getElementById("Atk").value = ((student.attack + student.WeaponAttack) * (1 + document.getElementById("EquAtk").value / 100)).toFixed(2);
	document.getElementById("SkillDmg").value = student.ExSkill;
	document.getElementById("Stable").value = student.Stability;
	CalculatorDmg();
}

function CharacterSelect(e)
{
	var idx = e.target.value;
	CharacterStatUpdate(idx);
}
function createCharacterList(CharacterList){ 
	var select = document.getElementById("character"); 
	select.addEventListener("click", CharacterSelect);
	for(var x = 0; x<CharacterList.length; x++){ 
		var option = document.createElement("option"); 
		option.setAttribute("value", x);
		option.appendChild(document.createTextNode(CharacterList[x].Name)); 
		select.appendChild(option);
	} 
} 
function getJson() {
	fetch('https://lonqie.github.io/SchaleDB/data/tw/students.min.json')
	//fetch('http://127.0.0.1:8000/student.json')		
		.then(result => result.json())
		.then((output) => {
			console.log('Output: ', output);
			//console.log('Name: ', output[0].Name);
			//console.log('AttackPower1: ', output[0].AttackPower1);
			//console.log('AttackPower100: ', output[0].AttackPower100);
			//console.log('CriticalDamageRate: ', output[0].CriticalDamageRate);
			//console.log('AccuracyPoint: ', output[0].StabilityPoint);	
			//console.log('AccuracyPoint: ', output[0].Equipment[0]);
			//console.log('AccuracyPoint: ', output[0].Equipment[2]);
			//console.log('AccuracyPoint: ', output[0].Weapon.AttackPower1);
			//console.log('AccuracyPoint: ', output[0].Weapon.AttackPower100);
			//console.log('AccuracyPoint: ', output[0].Skills[4].Desc);
			CharacterList = output;
			createCharacterList(CharacterList);
			
	}).catch(err => console.error(err));
	
	//fetch('https://lonqie.github.io/SchaleDB/data/summons.json')
}
function CalculatorDmg() {
	var myselect=document.getElementById("weak");
	var index=myselect.selectedIndex;
	var weak = parseFloat(myselect.options[index].value);
	myselect=document.getElementById("terrain");
	index=myselect.selectedIndex;
	var terrain = parseFloat(myselect.options[index].value);
	var Atk = parseFloat(document.getElementById("Atk").value);
	var EquAtk = parseFloat(document.getElementById("EquAtk").value / 100);
	var SPAtk = parseFloat(document.getElementById("SPAtk").value);
	var AtkBuff = parseFloat(document.getElementById("AtkBuff").value / 100);
	//var Star2Atk = parseFloat(document.getElementById("Star2Atk").value);
	var SkillDmg = parseFloat(document.getElementById("SkillDmg").value / 100) ;	
	var LevelCorrection = document.getElementById("LevelCorrection").value;
	var CrtDmgEqu = parseFloat(document.getElementById("CrtDmgEqu").value / 100);
	var CrtDmgBuff = parseFloat(document.getElementById("CrtDmgBuff").value / 100);
	var CrtDmgRes = parseFloat(document.getElementById("CrtDmgRes").value / 100);
	var Stable = parseFloat(document.getElementById("Stable").value);
	Stable = Stable / (1000 + Stable) + 0.2;
	var DefReduce = parseFloat(document.getElementById("DefReduce").value / 100);
	var BossDef = parseFloat(document.getElementById("BossDef").value);
	BossDef = BossDef * (1 - DefReduce);
	var atkAura = 0;
	var Ehnatk = 0;
	var kotamaAtkBuff = 0;
	var akoCrtDmgBuff = 0;
	var newAtkBuff = 0;
	var EhnCrtDmg = 0;
	var CrtDmgAura = 0;
	if (document.getElementById("atkAura").checked) {
		atkAura = parseFloat(document.getElementById("atkAura").value / 100);
	}
	if (document.getElementById("Ehnatk").checked) {
		Ehnatk = parseFloat(document.getElementById("Ehnatk").value / 100);
	}
	if (document.getElementById("kotamaAtkBuff").checked) {
		kotamaAtkBuff = parseFloat(document.getElementById("kotamaAtkBuff").value / 100);
	} 
	if (document.getElementById("akoCrtDmgBuff").checked) {
		akoCrtDmgBuff = parseFloat(document.getElementById("akoCrtDmgBuff").value / 100);
	}
	if (document.getElementById("newAtkBuff").checked) {
		newAtkBuff = parseFloat(document.getElementById("newAtkBuff").value / 100);
	}
	if (document.getElementById("EhnCrtDmg").checked) {
		EhnCrtDmg = parseFloat(document.getElementById("EhnCrtDmg").value / 100);
	}  
	if (document.getElementById("CrtDmgAura").checked) {
		CrtDmgAura = parseFloat(document.getElementById("CrtDmgAura").value / 100);
	}	
		
	var totalAtk = (Atk / (1 + EquAtk) + SPAtk) *  (1 + (AtkBuff + EquAtk + atkAura + Ehnatk + kotamaAtkBuff + newAtkBuff));
	var totalDmg = totalAtk * SkillDmg * LevelCorrection * weak * terrain;
	var dmgReduce = (BossDef + 1666.66) / 1666.66;
	var actualDmg = parseInt(totalDmg / dmgReduce);
	var actualDmgMin = parseInt(totalDmg * Stable / dmgReduce);
	var crtDmgRate = ((student.CriticalDamage + CrtDmgEqu) / 100) * (1 + CrtDmgBuff + akoCrtDmgBuff + EhnCrtDmg + CrtDmgAura) - CrtDmgRes;
	var crtDmg = parseInt(crtDmgRate * actualDmg);
	var crtDmgMin = parseInt(actualDmgMin * crtDmgRate);
	
	document.getElementById("dmgTableId").rows[1].cells[0].innerHTML = actualDmg;
	document.getElementById("dmgTableId").rows[1].cells[1].innerHTML = actualDmgMin;
	document.getElementById("dmgTableId").rows[1].cells[2].innerHTML = crtDmg;
	document.getElementById("dmgTableId").rows[1].cells[3].innerHTML = crtDmgMin;
}
window.onload = function() {
	getJson();
	document.getElementById("EquAtk").value = EquAtkKey[student.EquHead];
	document.getElementById("CrtDmgEqu").value = EquCrtDmgKey[student.EquHead] + EquCrtDmgKey[student.EquAcc];
	document.getElementById("Atk").value = ((student.attack + student.WeaponAttack) * (1 + document.getElementById("EquAtk").value / 100)).toFixed(2);
	CalculatorDmg();
}
</script>
</body></html>
